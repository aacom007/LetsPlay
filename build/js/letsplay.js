"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function e(e,t){for(var i=0;i<t.length;i++){var a=t[i];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(t,i,a){return i&&e(t.prototype,i),a&&e(t,a),t}}(),Game=function(){function e(t){if(_classCallCheck(this,e),!t)throw new Error("id is required.");this.gameid=t,this.domNode=null,this.selectedChoice="",this.isAlive=!1,this.date=null,this.title="",this.notify=!0}return _createClass(e,[{key:"addGame",value:function(e,t){if(this.domNode)return void this.updateGame(e);if(!t)throw new Error("container not specified");this._checkIsAlive(e.datetime),this.title=e.title;var i='<div class="game-card mdl-card mdl-shadow--6dp">\n              <div class="mdl-card__title mdl-card--border">\n                <h3 class="game-title mdl-card__title-text">'+e.title+'</h3>\n                <span class="new-game-tag" '+(this.isAlive?"":"hidden")+('>New</span>\n              </div>\n              <div class=" mdl-card__supporting-text mdl-card--border">\n                <div class="game-date">'+Util.formatedDateString(e.datetime)+'</div>\n                <div class="game-time">'+Util.formatedTimeString(e.datetime)+'</div>\n              </div>\n              <div class="game-venue mdl-card__supporting-text mdl-card--border">\n                <div>'+e.venue+"</div>\n              </div>\n            </div>"),a=document.createElement("div");a.innerHTML=i,this.domNode=a.firstChild,componentHandler.upgradeElement(this.domNode),t.insertBefore(this.domNode,t.firstChild)}},{key:"showAll",value:function(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];if(this.domNode){var t=this.domNode.querySelector(".choices"),i=this.domNode.querySelector(".response-container");e?(t?t.removeAttribute("hidden"):this.domNode.appendChild(this._choicesTemplate()),i?i.removeAttribute("hidden"):(this.domNode.appendChild(this._responsesTemplate()),IO.loadResponses(this.gameid,this.updateResponse.bind(this)))):(t&&t.setAttribute("hidden","true"),i&&i.setAttribute("hidden","true"))}}},{key:"updateGame",value:function(e){if(!this.domNode)throw new Error("dom node not found.");this._checkIsAlive(e.datetime),this.domNode.querySelector(".game-title").textContent=e.title,this.domNode.querySelector(".game-date").textContent=Util.formatedDateString(e.datetime),this.domNode.querySelector(".game-time").textContent=Util.formatedTimeString(e.datetime),this.domNode.querySelector(".game-venue").textContent=e.venue}},{key:"updateResponse",value:function(e){var t=e.userid,i=e.userinfo,a=e.choice;if(t&&i){var n=this.domNode.querySelector('.response-container span[data-uid="'+t+'"].response-item');if(!n){var s=document.createElement("span");s.className="response-item mdl-chip mdl-chip-contact",s.dataset.uid=t;var o=new Image(40,40);o.src=i.userpic||"/images/profile_placeholder.png",o.className="avatar mdl-chip__contact",s.appendChild(o);var r=document.createElement("span");r.className="mdl-chip__text user-name",r.textContent=i.username,s.appendChild(r),n=s}var d=this.gameid+"-"+a,c=this.domNode.querySelector("#"+d);c&&(c.appendChild(n),this.updateScore()),t===firebase.auth().currentUser.uid&&(this._updateUIOnChoiceChange(a),this.isAlive&&!this.selectedChoice&&Util.newGameNotification(this.title,this.date))}}},{key:"updateScore",value:function(){var e=this,t=["yes","no","maybe"];t.forEach(function(t){var i=e.domNode.querySelector("#"+e.gameid+"-"+t),a=i.hasChildNodes()?i.childNodes.length:0,n=e.domNode.querySelector(".score-"+t);n.dataset.badge=a})}},{key:"_choicesTemplate",value:function(){var e=document.createElement("div"),t="mdl-button mdl-js-button mdl-button--fab mdl-js-ripple-effect mdl-button--colored ";e.innerHTML='<div class="choices mdl-card__actions" >\n      <button class="choice choice-yes '+t+'" data-choice="yes" '+(this.isAlive?"":"disabled")+' ><i class="choice-icon material-icons">thumb_up</i></button>\n      <div class="score score-yes mdl-badge mdl-badge--overlap" data-badge="0"></div>\n      <button class="choice choice-no '+t+'" data-choice="no" '+(this.isAlive?"":"disabled")+' ><i class="choice-icon material-icons">thumb_down</i></button>\n      <div class="score score-no mdl-badge mdl-badge--overlap" data-badge="0"></div>\n      <button class="choice choice-maybe '+t+'" data-choice="maybe" '+(this.isAlive?"":"disabled")+' ><i class="choice-icon material-icons">thumbs_up_down</i></button>\n      <div class="score score-maybe mdl-badge mdl-badge--overlap" data-badge="0"></div>\n    </div>';var i=e.firstChild;return this.isAlive&&i.addEventListener("click",this.onChoiceSelected.bind(this)),componentHandler.upgradeElement(i),i}},{key:"_responsesTemplate",value:function(){var e=document.createElement("div");e.innerHTML='<div class="response-container mdl-tabs mdl-js-tabs mdl-js-ripple-effect" >\n      <div class="response-tab-bar mdl-tabs__tab-bar">\n        <div><a href="#'+this.gameid+'-yes" class="response-tab-in mdl-tabs__tab is-active" >IN</a></div>\n        <div><a href="#'+this.gameid+'-no" class="response-tab-out mdl-tabs__tab ">OUT</a></div>\n        <div><a href="#'+this.gameid+'-maybe" class="mdl-tabs__tab">MAY BE</a></div>\n      </div>\n      <div id="'+this.gameid+'-yes" class="tab-panel mdl-tabs__panel is-active" data-placeholder="Be the first to reply."></div>\n      <div id="'+this.gameid+'-no" class="tab-panel mdl-tabs__panel "></div>\n      <div id="'+this.gameid+'-maybe" class="tab-panel mdl-tabs__panel"></div>\n    </div>';var t=e.firstChild;return componentHandler.upgradeElement(t),t}},{key:"onChoiceSelected",value:function(e){if(e.target&&(e.target.classList.contains("choice")||e.target.classList.contains("choice-icon"))){var t=this.gameid,i=e.target.dataset.choice||e.target.parentNode.dataset.choice;if(!t||!i)return;if(i===this.selectedChoice)return;var a=new CustomEvent("choiceMade",{detail:{gameId:t,choice:i}});this.domNode.dispatchEvent(a)}}},{key:"_updateUIOnChoiceChange",value:function(e){var t=this.selectedChoice;if(e!==t){this.selectedChoice=e,this.domNode.querySelectorAll(".choices .selected").forEach(function(e){e.classList.remove("selected")});var i=this.domNode.querySelector(".choice-"+e);i.classList.add("selected");var a=this.domNode.querySelector(".new-game-tag");a&&a.setAttribute("hidden","true")}}},{key:"_checkIsAlive",value:function(e){var t=new Date(e);"Invalid Date"==t||t<=Date.now()?this.isAlive=!1:this.isAlive=!0,this.date=t}}]),e}(),_createClass=function(){function e(e,t){for(var i=0;i<t.length;i++){var a=t[i];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(t,i,a){return i&&e(t.prototype,i),a&&e(t,a),t}}(),IO=function(){function e(){_classCallCheck(this,e)}return _createClass(e,null,[{key:"initialize",value:function(){this.gamesRef=firebase.database().ref().child("games"),this.gamesRef.off(),this.gameResponsesRef=firebase.database().ref().child("responses"),this.gameResponsesRef.off(),this.usersRef=firebase.database().ref().child("users"),this.usersRef.off(),this.notificationRef=firebase.database().ref("notifications"),this.notificationRef.off()}},{key:"initializeNotifications",value:function(){this.notificationRef.on("value",function(e){e.exists()&&Util.notifyMe(e.val())})}},{key:"registerUser",value:function(e){var t=this;this.getUserInfo(e.uid).then(function(i){if(!i.exists()){var a={};a["/"+e.uid]={username:e.username,userpic:e.userpic},t.usersRef.update(a).then(function(){return console.log("user registered.")})}})}},{key:"getUserInfo",value:function(e){return this.usersRef.child(e).once("value")}},{key:"loadGames",value:function(e){this.gamesRef.on("child_added",function(t){console.log("adding "+t.key),e({gameid:t.key,metadata:t.val()})}),this.gamesRef.on("child_changed",function(t){console.log("changed "+t.key),e({gameid:t.key,metadata:t.val()})})}},{key:"loadResponses",value:function(e,t){var i=this;if(!e)throw new Error("Invalid parameters");this.gameResponsesRef.child(e).on("child_added",function(e){i.getUserInfo(e.key).then(function(i){t({userid:i.key,userinfo:i.val(),choice:e.val()})})}),this.gameResponsesRef.child(e).on("child_changed",function(e){i.getUserInfo(e.key).then(function(i){t({userid:i.key,userinfo:i.val(),choice:e.val()})})})}},{key:"registerResponse",value:function(e,t,i,a){this.gameResponsesRef.child("/"+e+"/"+t).set(i).then(function(e){a&&a()})}}]),e}();!function(){var e={gamesContainer:document.querySelector(".main"),userMenuContainer:document.querySelector(".user-menu-wrapper"),userPic:document.querySelector(".user-pic"),signInBtn:document.querySelector(".sign-in"),signOutBtn:document.querySelector("#signOut"),title:document.querySelector(".header-title"),message:document.querySelector("#snackbar"),registry:null},t={yes:"Alright! See you at the ground. 😃",no:"Ohh! We'll miss you ☹️. And you gonna miss the Fun.",maybe:"Still thinking 🤔  decide fast."};e.init=function(){if(e.registry=new Map,!(window.firebase&&firebase.app instanceof Function))return window.alert("Sorry, unable to load required files."),void console.error("Unable to load firebase.");var t={apiKey:"AIzaSyA4s5WAv0Zv00VZrQhEXMDImwiWsSpYMBw",authDomain:"letsplay-a07f7.firebaseapp.com",databaseURL:"https://letsplay-a07f7.firebaseio.com",storageBucket:"letsplay-a07f7.appspot.com",messagingSenderId:"40702620919"};firebase.initializeApp(t),IO.initialize(),IO.loadGames(e.addUpdateGameCard),e.auth=firebase.auth(),e.auth.onAuthStateChanged(e.onAuthStateChangedListner)},e.onAuthStateChangedListner=function(t){if(t){console.log("user "+t.displayName+" logged in");var i={uid:t.uid,username:t.displayName,userpic:t.photoURL};IO.registerUser(i);var a=t.displayName.slice(0,t.displayName.lastIndexOf(" "));e.message.classList.remove("mdl-snackbar--active"),e.title.textContent="Let's Play "+a,e.userPic.style.backgroundImage="url("+t.photoURL+")",e.signInBtn.setAttribute("hidden","true"),e.userMenuContainer.removeAttribute("hidden"),e.registry.forEach(function(e){return e.showAll()})}else{console.log("user logged out"),e.title.textContent="Let's Play",e.userMenuContainer.setAttribute("hidden","true"),e.signInBtn.removeAttribute("hidden");var n={message:"Sign in to register your response. And view who all are coming to play.",timeout:5e3};if(e.message.MaterialSnackbar)e.message.MaterialSnackbar.showSnackbar(n);else{var s=e.message.querySelector(".mdl-snackbar__text");s.textContent=n.message,e.message.classList.add("mdl-snackbar--active")}e.registry.forEach(function(e){return e.showAll(!1)})}},e.signInBtn.addEventListener("click",function(){var t=new firebase.auth.GoogleAuthProvider;e.auth.signInWithRedirect(t)}),e.signOutBtn.addEventListener("click",function(){e.auth.signOut()}),e.addUpdateGameCard=function(t){var i=t.gameid,a=t.metadata,n=e.registry.get(i);n?n.updateGame(a):(n=new Game(i),n.addGame(a,e.gamesContainer),e.auth.currentUser&&n.showAll(),n.domNode.addEventListener("choiceMade",e.onChoiceMade),e.registry.set(i,n))},e.onChoiceMade=function(i){IO.registerResponse(i.detail.gameId,e.auth.currentUser.uid,i.detail.choice,function(){var a={message:t[i.detail.choice],timeout:3500};e.message.MaterialSnackbar.showSnackbar(a)})},window.onload=function(){"serviceWorker"in navigator&&navigator.serviceWorker.register("/sw.js"),e.init()}}();var _createClass=function(){function e(e,t){for(var i=0;i<t.length;i++){var a=t[i];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(t,i,a){return i&&e(t.prototype,i),a&&e(t,a),t}}(),Util=function(){function e(){_classCallCheck(this,e)}return _createClass(e,null,[{key:"newGameNotification",value:function(e,t){var i="Scheduled for "+this.formatedDateString(t)+". Register your response.",a={body:i,icon:"images/icons/icon/icon-128.png"};if("Notification"in window&&"granted"===Notification.permission){if(i){new Notification(e,a)}}else"Notification"in window&&"denied"!==Notification.permission&&Notification.requestPermission(function(t){if("granted"===t&&i){new Notification(e,a)}})}},{key:"formatedDateString",value:function(e){if(e){var t=null;if(t=e instanceof Date?e:new Date(e)){var i={weekday:"short",day:"2-digit",month:"short",year:"numeric"};return t.toLocaleString("en-US",i)}}}},{key:"formatedTimeString",value:function(e){if(!e)return"";var t=null;if(t=e instanceof Date?e:new Date(e)){var i={hour:"2-digit",minute:"2-digit"};return t.toLocaleString("en-US",i)}}}]),e}();